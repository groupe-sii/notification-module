(function() {
	var process = function() {
		var tabContainers = $('.tab-container');
		for(var i=0 ; i<tabContainers.length ; i++) {
			generateTabContainer(i, tabContainers[i]);
		}
	}
	
	var generateTabContainer = function(/*int*/group, /*Node*/container) {
		var contentContainer = $(container).children('.content');
		var height = computeMaxHeight($('.tab > .content', container))
		$(contentContainer).append('<div class="tabs-wrapper">');
		$(contentContainer).append('<div class="tabs-content-wrapper">');
		var tabWrapper = $(contentContainer).children('.tabs-wrapper');
		var tabContentWrapper = $(contentContainer).children('.tabs-content-wrapper');
		var tabs = $(contentContainer).children('.tab');
		for(var i=0 ; i<tabs.length ; i++) {
			// get parts generated by asciidoctor:
			// - title of a particular tab
			// - content of a particular tab
			var tab = tabs[i];
			var tabTitleNode = $(tab).children('.title');
			var tabTitle = tabTitleNode.html();
			var contentNode = $(tab).children('.content');
			// transform html to:
			// <div class="tab-container">                     | container
			//  *                                              | anything else that don't belong to a tab
			//  <div class="tabs-wrapper">                     | container for styling
			//    <div class="tab">                            | one tab
			//      <input type="radio" />                     | selection of tab
			//      <label class="tab-label">${title}</label>  | title of tab
			//  <div class="tabs-content-wrapper">             | container for styling
			//    <div class="tab-content">                    | content of tab
			//      ${contentNodes}
			$(tabWrapper).append(tab);
			$(tab).prepend('<input type="radio" id="tab-'+group+'-'+i+'" value="'+i+'" name="tab-group-'+group+'" '+(i==0 ? 'checked' : '')+'>');
			tabTitleNode.replaceWith('<label class="tab-label" for="tab-'+group+'-'+i+'">'+tabTitle+'</label>');
			
			$(tabContentWrapper).append(contentNode);
			$(contentNode).addClass('tab-content');
			if (i == 0) {
				$(contentNode).addClass('selected');
			}
		}
		$(tabContentWrapper).css('height', (height+computeContainerHeight(tabContentWrapper)+10)+'px');		// add 10px for possible vertical scrollbar that may appear
		listen(tabWrapper, tabContentWrapper);
		$(container).addClass('ready');
	}
	
	var computeMaxHeight = function(/*Node[]*/contents) {
		var height = 0;
		for(var i=0 ; i<contents.length ; i++) {
			var contentHeight = computeHeight($(contents[i]));
			if(contentHeight>height) {
				height = contentHeight;
			}
		}
		return height;
	}
	
	var listen = function(/*Node*/tabWrapper, /*Node*/tabContentWrapper) {
		$('input[type="radio"]', tabWrapper).change(function() {
			var tabContents = $('.tab-content', tabContentWrapper);
			tabContents.removeClass('selected');
			$(tabContents[$(this).attr('value')]).addClass('selected');
		});
	}
	
	var computeHeight = function(/*Node[]*/nodes) {
		var totalHeight = 0;
		for(var i=0 ; i<nodes.length ; i++) {
			$(nodes[i]).css('position', 'relative');
			totalHeight += $(nodes[i]).outerHeight(true);
			$(nodes[i]).css('position', '');
		}
		return totalHeight;
	}
	
	var computeContainerHeight = function(/*Node*/ container) {
		var children = $('> *', container);
		for (var i=0 ; i<children.length ; i++) {
			$(children[i]).css('display', 'none');
		}
		var height = $(container).outerHeight();
		for (var i=0 ; i<children.length ; i++) {
			$(children[i]).css('display', '');
		}
		return height;
	}
	
	$(document).ready(process);
})();