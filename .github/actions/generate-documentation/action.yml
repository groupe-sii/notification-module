name: Generate documentation
description: "Generate documentation"
inputs:
  ogham-version:
    description: "The Ogham version for the generated documentation"
    required: false
    default: ""
  git-branch:
    description: "The Git branch for the Ogham version"
    required: false
    default: ""
runs:
  using: "composite"
  steps:
#    - name: "Build custom Pitest version"
#      shell: bash
#      run: ci/./build-pitest.sh
    - name: "Restore Pitest reports generated by each module - download"
      uses: actions/download-artifact@v3
      with:
        path: /tmp
    - name: "Restore Pitest reports generated by each module - extract"
      shell: bash
      run: for file in `find /tmp -name 'pit-reports-*.tar.gz' -type f`; do tar -xzf "$file"; done
    - name: "Generate reports and documentation"
      #        uses: nick-fields/retry@v2
      #        with:
      #          timeout_minutes: 120
      #          max_attempts: 3
      #          command: |
      shell: bash
      run: |
        ARGS="$(test -z '${{ inputs.ogham-version }}' && '' || '-Ddoc.ogham.version=${{ inputs.ogham-version }}')"
        ARGS="$ARGS $(test -z '${{ inputs.git-branch }}' && '' || '-Dgit.branch=${{ inputs.git-branch }}')"
        export JAVA_TOOL_OPTIONS='-Xmx4096m'
        export MAVEN_OPTS='-Xmx4096m'
        ci/./generate-documentation.sh $ARGS
    - name: "Generate showcase video"
      uses: nick-fields/retry@v2
      with:
        timeout_minutes: 30
        max_attempts: 3
        command: ci/./generate-showcase-video.sh
    - name: "Save generated documentation"
      uses: ./.github/actions/archive-and-upload
      with:
        file-pattern: "target/**.*"
        artifact-name: documentation
